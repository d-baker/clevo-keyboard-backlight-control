#! /bin/bash
set -o nounset

grep -q "kb_off=1" /etc/modprobe.d/clevo-xsm-wmi.conf
backlight_off=$? # Is the backlight off or on?
rootdir="/home/dbaker/bin/kb-utility" # TODO fix this
tdir="$rootdir/kb-templates" # template folder
default="$rootdir/default.txt"

if [ ! -f "$rootdir/state.txt" ]
then
    > state.txt
fi

if [ $# -eq 0 ]
  then
    printf "No arguments supplied, acting as a backlight toggle.\n\n"

   # Toggle backlight
   if [ $backlight_off -eq 0 ]
    then
        echo "> Turning on keyboard backlight..."
        # Concatenate color state with ON code
        # Use a default if no existing state

        if [ ! -s "$rootdir/state.txt" ]
        then
            echo "No existing state, falling back to default."
            cat "$rootdir/kb-on.txt" "$default" | sudo tee /etc/modprobe.d/clevo-xsm-wmi.conf > /dev/null
        else
            echo "Using last set colorscheme."
            cat "$rootdir/kb-on.txt" "$rootdir/state.txt" | sudo tee /etc/modprobe.d/clevo-xsm-wmi.conf > /dev/null
        fi

        sudo modprobe -r clevo_xsm_wmi
        sudo modprobe clevo_xsm_wmi
        printf "\nKeyboard backlight turned on\n"
    else
        echo "> Turning off keyboard backlight..."
        cat "$rootdir/kb-off.txt" | sudo tee /etc/modprobe.d/clevo-xsm-wmi.conf > /dev/null
        sudo modprobe -r clevo_xsm_wmi
        sudo modprobe clevo_xsm_wmi
        printf "\nKeyboard backlight turned off\n"
    fi

else
    # Check if requested colorscheme file exists
    if [ -f "$tdir/$1.txt" ]
    then
        printf "> Changing colors...\n"
        cat "$tdir/$1.txt" > "$rootdir/state.txt" # Overwrite state file with chosen color scheme
        echo "> Turning on keyboard backlight..."
        # Concatenate color state with ON code
        cat "$rootdir/kb-on.txt" "$rootdir/state.txt" | sudo tee /etc/modprobe.d/clevo-xsm-wmi.conf > /dev/null
        sudo modprobe -r clevo_xsm_wmi
        sudo modprobe clevo_xsm_wmi
        printf "\nKeyboard backlight turned on, color changed and state saved\n"
    else
        printf "Sorry, that colorscheme doesn't exist. Try one of these:\n\n"
        for template in $tdir/*; do
            stripped=${template%.*}
            echo ${stripped##*/}
        done
        exit
    fi
fi
